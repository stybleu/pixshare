{% extends "base.html" %}
{% set title = "Pixshare" %}
{% block content %}

<style>
  /* Scope : évite d’impacter toute la page */
  .df *{
    font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
  }
  .df .btn, .df .form-control, .df .form-select{
    border-radius: 12px;
  }
</style>

<div class="df">

  <!-- Header responsive -->
  <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
    <div>
      <h1>Héberger une image anonymement sans compte</h1>
    </div>

    <div class="d-flex gap-2">
      {% if admin %}
        <a class="btn btn-sm btn-outline-dark" href="{{ url_for('admin_panel') }}">Admin</a>
      {% endif %}
    </div>
  </div>

  <!-- ✅ Grille responsive : 1 colonne mobile / 2 colonnes PC -->
  <div class="row g-3 align-items-start">

    <!-- Upload -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h6">Uploader un fichier (suppression automatique)</h2>
          <p class="text-muted small mb-3">
            Taille max : {{ max_mb }} Mo.
            En envoyant un fichier, tu acceptes les <a href="{{ url_for('cgu') }}">CGU</a>.
          </p>

          <form method="POST" enctype="multipart/form-data" class="row g-2 align-items-end">
            <div class="col-12">
              <label class="form-label">Choisir un fichier</label>
              <input class="form-control" type="file" name="file" required>
            </div>

            <!-- ✅ Durée de vie (max 30 min) -->
            <div class="col-12">
              <label class="form-label">Durée de vie du fichier</label>
              <select name="lifetime" class="form-select">
                <option value="5" selected>5 minutes</option>
                <option value="10">10 minutes</option>
                <option value="20">20 minutes</option>
                <option value="30">30 minutes (max)</option>
              </select>
              <div class="form-text">
                Le fichier sera supprimé automatiquement après expiration.
              </div>
            </div>

            <!-- ✅ Sur mobile le bouton prend toute la largeur -->
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit">Uploader</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tes fichiers -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h2 class="h6 mb-0">Tes fichiers</h2>
            {% if guest_files and guest_files|length > 0 %}
              <span class="badge text-bg-success">{{ guest_files|length }} actif(s)</span>
            {% else %}
              <span class="badge text-bg-secondary">Aucun</span>
            {% endif %}
          </div>

          <hr class="my-3">

          {% if guest_files and guest_files|length > 0 %}

            {% for f in guest_files %}
              {% set public_url = f.view_url if f.previewable else f.download_url %}
              <div class="mb-3 p-2 border rounded">

                <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                  <div>
                    <div class="fw-semibold">{{ f.original }}</div>
                    <div class="text-muted small">
                      {{ f.size_h }} — {{ f.mtime_h }}
                      {% if f.remaining_h %}
                        <span class="ms-2 badge text-bg-warning">
                          Expire dans {{ f.remaining_h }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2">
                  <a class="btn btn-success btn-sm" href="{{ public_url }}" target="_blank" rel="noopener">Ouvrir</a>
                  <a class="btn btn-primary btn-sm" href="{{ f.download_url }}">Télécharger</a>
                </div>

                <div class="text-muted small mt-3 mb-1">Lien public à partager :</div>

                <div class="input-group">
                  <input
                    id="publicLink_{{ f.id }}"
                    class="form-control"
                    value="{{ public_url }}"
                    readonly
                    onclick="this.select()"
                  >
                  <button type="button" class="btn btn-outline-primary" onclick="copyById('publicLink_{{ f.id }}')">
                    Copier
                  </button>
                </div>

                <div class="text-muted small mt-2">
                  Le lien devient invalide après expiration (suppression automatique).
                </div>

              </div>
            {% endfor %}

          {% else %}
            <p class="text-muted mb-0">
              Aucun fichier. Choisissez-en puis cliquez sur <b>Uploader</b>.
            </p>
          {% endif %}

        </div>
      </div>
    </div>

  </div>
</div>

<script>
  function copyById(id){
    const input = document.getElementById(id);
    if(!input) return;
    input.focus();
    input.select();
    input.setSelectionRange(0, 999999);

    (navigator.clipboard?.writeText(input.value) || Promise.reject())
      .catch(() => document.execCommand("copy"));
  }
</script>

{% endblock %}